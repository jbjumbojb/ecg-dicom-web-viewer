<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" href="index.css" />
    </head>

    <body>
        <div>
            <div>
                <input type="file" id="files" />
            </div>
            <!--<div id="canvasECG" style="height: 100%;"></div>-->
            <div id="ecgView"></div>
        </div>
        <script src="index.umd.js"></script>    
        <script type="application/javascript">
            var input = document.getElementById("files"), output = document.getElementById('output');

            // Eventhandler for file input. 
            window.addEventListener('load', () => {
                // Function to extract query parameters
                function getQueryParameter(name) {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get(name);
                }

                // Check if `url` parameter exists in the query string
                const fileUrl = getQueryParameter('url');
                if (fileUrl) {
                    // Fetch the file from the specified URL
                    fetch(fileUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            // Simulate file selection to trigger openfile function
                            openfile({ fileBlob: blob });
                        })
                        .catch(error => {
                            console.error('Error fetching file:', error);
                        });
                }
            });

            function openfile(evt) {
                var fileData;
                if (evt.fileBlob) {
                    // Use the Blob passed from the fetch
                    fileData = evt.fileBlob;
                } else {
                    // Handle files selected from input
                    var files = evt.target.files;
                    fileData = new Blob([files[0]]);
                }

                // Create a Promise to handle the file data
                var promise = new Promise(getBuffer(fileData));
                promise.then(function(data) {
                    output.innerHTML = data.toString();
                    console.log(data);
                }).catch(function(err) {
                    console.log('Error:', err);
                });
            }

            function getBuffer(fileData) {
                return function(resolve) {
                    var reader = new FileReader();
                    reader.readAsArrayBuffer(fileData);
                    reader.onload = function() {
                        var arrayBuffer = reader.result;
                        let viewer = new $.DicomECGViewer(arrayBuffer, "ecgView", '0');
                        viewer.loadCanvas();
                    }
                }
            }
            document.getElementById('files').addEventListener('change', openfile, false);
        </script>
    </body>
</html>